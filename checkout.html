<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checkout - DP Biotech</title>
<script>
    if (sessionStorage.getItem('isAuthenticated') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg:#ffffff; --text:#0a0a0a; --muted:#525252; --line:#e5e5e5; --card:#fafafa; 
    --a1:#0ea5e9; --a2:#6366f1; --a3:#8b5cf6;
    /* Mini Colors */
    --mini-1:#f97316; --mini-2:#ef4444;
    /* Pro Colors */
    --pro-1:#2563eb; --pro-2:#059669;
  }
  @media (prefers-color-scheme: dark){ 
    :root { --bg:#0a0a0a; --text:#fafafa; --muted:#a1a1aa; --line:#262626; --card:#18181b; } 
  }
  body{
    margin:0; 
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background:var(--card); 
    color:var(--text);
  }
  .container{max-width:1200px; margin:0 auto; padding:0 20px}
  .nav{position:sticky; top:0; z-index:50; background:color-mix(in srgb, var(--bg) 80%, transparent); backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--line)}
  .nav-inner{height:57px; display:flex; align-items:center; justify-content:space-between}
  .logo{display:flex; gap:8px; align-items:center; font-weight:600; letter-spacing:-0.02em; font-size: 18px;}
  .nav a{color:inherit; text-decoration:none}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:12px; border:1px solid var(--line); font-weight:600; font-size:14px; background:transparent; color:inherit; cursor:pointer; text-decoration: none;}
  .btn.primary{background:var(--text); color:var(--bg); border-color:transparent}
  .btn.primary:hover{opacity:0.9}
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .checkout-layout { display: grid; grid-template-columns: 3fr 2fr; gap: 32px; align-items: start; }
  @media(max-width: 900px) { .checkout-layout { grid-template-columns: 1fr; } }
  .page-header { padding: 48px 0 24px 0; }
  h1 { font-size: 32px; letter-spacing: -0.02em; margin: 0; }
  .order-items { display: flex; flex-direction: column; gap: 16px; }
  .product-card { display: flex; gap: 16px; background: var(--bg); border: 1px solid var(--line); border-radius: 16px; padding: 16px; position: relative; }
  .product-info { flex-grow: 1; }
  .product-title { font-size: 16px; font-weight: 600; margin: 0; }
  .product-subtitle { font-size: 13px; color: var(--muted); margin: 4px 0 0 0; }
  .product-price { font-size: 15px; font-weight: 500; margin-top: 12px; }
  .title-dp-mini { background: linear-gradient(90deg, var(--mini-1), var(--mini-2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
  .title-dp-pro { background: linear-gradient(90deg, var(--pro-1), var(--pro-2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
  .quantity-control { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
  .quantity-btn { width: 32px; height: 32px; border-radius: 8px; font-size: 20px; line-height: 1; }
  .quantity-input { width: 40px; height: 32px; text-align: center; border: 1px solid var(--line); border-radius: 8px; font-family: inherit; font-weight: 600; -moz-appearance: textfield; background: var(--card); color: var(--text); }
  .quantity-input::-webkit-outer-spin-button, .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .remove-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; line-height: 1; padding: 0; cursor: pointer; color: var(--muted); transition: color .2s ease; }
  .remove-btn:hover { color: var(--text); }
  .summary-box { background: var(--bg); border: 1px solid var(--line); border-radius: 16px; padding: 24px; position: sticky; top: calc(57px + 24px); }
  .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 15px; }
  .summary-row.total { font-size: 18px; font-weight: 700; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--line); }
  .summary-box .btn.primary { width: 100%; padding: 14px; font-size: 16px; margin-top: 24px; }
  .empty-cart-container { text-align: center; padding: 80px 20px; margin-top: 48px; background: var(--bg); border: 1px solid var(--line); border-radius: 16px; }
  
  /* MODIFICA 1: Stile per il campo di input dell'email */
  .form-group { margin-bottom: 16px; margin-top: 24px; }
  .text-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-family: inherit;
      font-size: 15px;
      box-sizing: border-box;
  }
  .text-input:focus {
      outline: none;
      border-color: var(--a2);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--a2) 20%, transparent);
  }
</style>
</head>
<body>
  <div class="nav">
    <div class="container nav-inner">
      <a href="index.html" class="logo">
        <img src="logo.png" alt="DP Biotech Logo" style="height:34px; border-radius:50%;">
        <span>DP Biotech</span>
      </a>
      <a href="index.html" class="btn">Back to Shop</a>
    </div>
  </div>

  <div class="container">
    <div id="checkout-content">
      </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const checkoutContent = document.getElementById('checkout-content');
    let cart = [];
    const EUR = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' });

    const SERVER_URL = 'https://server-pagamenti-dp.onrender.com';

    function loadCart() {
      const savedCart = sessionStorage.getItem('shoppingCart');
      cart = savedCart ? JSON.parse(savedCart) : [];
      renderPage();
    }

    function saveCart() {
      sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
      renderPage();
    }

    function formatOptions(options) {
        if (typeof options === 'object' && options !== null) {
            return Object.values(options).filter(val => val).join(', ');
        }
        return options || '';
    }
    
    function changeQuantity(itemId, amount) {
        if (amount > 0) {
            const itemToAdd = cart.find(item => item.id === itemId);
            if (itemToAdd) {
                cart.push({...itemToAdd});
            }
        } else if (amount < 0) {
            const itemIndexToRemove = cart.findIndex(item => item.id === itemId);
            if (itemIndexToRemove > -1) {
                cart.splice(itemIndexToRemove, 1);
            }
        }
        saveCart();
    }

    function removeItem(itemId) {
        cart = cart.filter(item => item.id !== itemId);
        saveCart();
    }

    function renderPage() {
      if (cart.length === 0) {
        checkoutContent.innerHTML = `
          <div class="empty-cart-container">
            <h1>Your Cart is Empty</h1>
            <p style="margin-bottom: 24px;">Looks like you haven't added anything to your cart yet.</p>
            <a href="index.html" class="btn primary">Start Shopping</a>
          </div>
        `;
        return;
      }

      const consolidatedCart = {};
      cart.forEach(item => {
        if (consolidatedCart[item.id]) {
          consolidatedCart[item.id].quantity++;
        } else {
          consolidatedCart[item.id] = { ...item, quantity: 1 };
        }
      });
      const displayCart = Object.values(consolidatedCart);

      let subtotal = 0;
      cart.forEach(item => { subtotal += item.price; });
      const shipping = 49.90;
      const total = subtotal + shipping;

      let itemsHTML = '';
      displayCart.forEach((item) => {
        const baseName = item.name.split('(')[0].trim();
        const formattedOptions = formatOptions(item.options);
        
        let titleClass = '';
        if (baseName.toLowerCase().includes('dp mini')) {
            titleClass = 'title-dp-mini';
        } else if (baseName.toLowerCase().includes('dp pro')) {
            titleClass = 'title-dp-pro';
        }

        itemsHTML += `
          <div class="product-card">
            <div class="product-info">
              <h3 class="product-title ${titleClass}">${baseName}</h3>
              <p class="product-subtitle">${formattedOptions}</p>
              <p class="product-price">${EUR.format(item.price)}</p>
              <div class="quantity-control">
                <button class="btn quantity-btn" data-action="decrease" data-id="${item.id}">-</button>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1" readonly>
                <button class="btn quantity-btn" data-action="increase" data-id="${item.id}">+</button>
              </div>
            </div>
            <button class="remove-btn" data-action="remove" data-id="${item.id}">&times;</button>
          </div>
        `;
      });
      
      checkoutContent.innerHTML = `
        <div class="page-header">
            <h1>Your Order</h1>
        </div>
        <div class="checkout-layout">
          <main>
            <div class="order-items">${itemsHTML}</div>
          </main>
          <aside>
            <div class="summary-box">
              <h2>Summary</h2>
              <div class="summary-row">
                <span>Subtotal</span>
                <span>${EUR.format(subtotal)}</span>
              </div>
              <div class="summary-row">
                <span>Shipping</span>
                <span>${EUR.format(shipping)}</span>
              </div>
              <div class="summary-row total">
                <span>Total</span>
                <span>${EUR.format(total)}</span>
              </div>
              
              <div class="form-group">
                <input type="email" id="email-input" class="text-input" placeholder="Your Email Address" required>
              </div>

              <button id="checkout-button" class="btn primary">Proceed to Payment</button>
            </div>
          </aside>
        </div>
      `;
      
      const checkoutButton = document.getElementById('checkout-button');
      checkoutButton.addEventListener('click', async () => {
          // MODIFICA 3: Leggi e valida l'email prima di inviare
          const emailInput = document.getElementById('email-input');
          const email = emailInput.value.trim();

if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
              alert('Please enter a valid email address.');
              emailInput.focus();
              return;
          }

          checkoutButton.disabled = true;
          checkoutButton.textContent = 'Redirecting to payment...';

          try {
              const response = await fetch(`${SERVER_URL}/create-checkout-session`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  // MODIFICA 4: Invia l'email insieme al carrello
                  body: JSON.stringify({ cart: cart, customerEmail: email })
              });
              
              const session = await response.json();

              if (session.url) {
                  window.location.href = session.url;
              } else {
                  alert('Error: ' + (session.error || 'Could not create payment session.'));
                  checkoutButton.disabled = false;
                  checkoutButton.textContent = 'Proceed to Payment';
              }

          } catch (error) {
              console.error('Error:', error);
              alert('Could not contact the payment server. Please try again later.');
              checkoutButton.disabled = false;
              checkoutButton.textContent = 'Proceed to Payment';
          }
      });
    }

    checkoutContent.addEventListener('click', (event) => {
        const target = event.target;
        const action = target.dataset.action;
        const id = target.dataset.id; 

        if (!id) return;

        if (action === 'increase') {
            changeQuantity(id, 1);
        } else if (action === 'decrease') {
            changeQuantity(id, -1);
        } else if (action === 'remove') {
            removeItem(id);
        }
    });
    
    loadCart();
  });
</script>
</body>
</html>